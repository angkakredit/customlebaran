<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SUPER CBT Nasional – ANBK</title>
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f0f2f5}
header{background:#2b7cff;color:#fff;padding:15px;text-align:center;font-size:20px}
.container{display:flex;margin:20px}
.sidebar{width:60px;background:#e0e0e0;padding:10px;border-radius:10px;overflow-y:auto;height:80vh}
.sidebar button{width:100%;margin:5px 0;padding:10px;border:none;border-radius:6px;background:#2b7cff;color:#fff;cursor:pointer}
.main{flex:1;background:#fff;padding:20px;border-radius:10px;margin-left:20px;min-height:80vh;box-shadow:0 0 10px rgba(0,0,0,0.1)}
button,input,textarea,select{font-size:14px}
input,textarea,select{width:100%;margin:5px 0;padding:8px;border-radius:6px;border:1px solid #ccc}
#timer{font-weight:bold;font-size:18px;color:#ff0000}
</style>
</head>
<body>

<header>SUPER CBT Nasional – ANBK</header>

<!-- LOGIN -->
<div class="main" id="loginBox">
<h2>Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="loginUser()">Login</button>
</div>

<!-- UJIAN SISWA -->
<div class="container" id="examBox" style="display:none">
<div class="sidebar" id="questionNav"></div>
<div class="main">
<h2>Ujian Online - Kelas: <span id="kelasSiswa"></span></h2>
<div id="questions"></div>
<div><b>Jawaban Esai:</b><textarea id="essayAnswer" rows="4" placeholder="Tulis jawaban esai disini..."></textarea></div>
<div>Timer: <span id="timer">00:00</span></div>
<video id="video" autoplay muted width="200" style="margin-top:10px"></video>
<div style="margin-top:10px">
<button onclick="prevQuestion()">Prev</button>
<button onclick="nextQuestion()">Next</button>
<button onclick="finishExam()">Selesai Ujian</button>
</div>
</div>
</div>

<!-- MENU GURU -->
<div class="main" id="guruBox" style="display:none">
<h2>Menu Guru</h2>
<h3>CRUD Soal</h3>
<input id="idSoal" placeholder="ID Soal">
<input id="mapel" placeholder="Mata Pelajaran">
<input id="kelas" placeholder="Kelas">
<input id="soalText" placeholder="Soal">
<input id="A" placeholder="A">
<input id="B" placeholder="B">
<input id="C" placeholder="C">
<input id="D" placeholder="D">
<input id="jawaban" placeholder="Jawaban">
<button onclick="tambahSoal()">Tambah Soal</button>
<button onclick="editSoal()">Edit Soal</button>
<button onclick="hapusSoal()">Hapus Soal</button>

<h3>Hasil Siswa Sekolah</h3>
<table border="1" id="hasilTable">
<tr><th>Nama</th><th>Kelas</th><th>Skor</th><th>Persen</th><th>Pelanggaran</th><th>Status Kecurangan</th><th>Foto Pelanggaran</th></tr>
</table>

<h3>Dashboard Nilai</h3>
<canvas id="dashboard" width="400" height="200"></canvas>
<button onclick="loadDashboard()">Refresh Dashboard</button>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbwTkTPjD50a2z5OPLp6NVQ18NQ_5WrLUvddlthXRkzkiGw-4SVnIlJ6Yp2zWV7HrClu/exec";

let studentName="", studentUser="", studentKelas="", studentSekolah="";
let questions=[], currentQuestion=0, timerInterval;
let violationCount=0, violationPhoto="", studentLocation="";
let answers={};

// ===== LOGIN =====
function loginUser(){
  const u=username.value, p=password.value;
  if(!u||!p) return alert("Isi username & password");
  fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({mode:"login",username:u,password:p})})
  .then(r=>r.json()).then(data=>{
    if(!data.status){alert("Login gagal"); return;}
    if(data.role==="guru"){loginBox.style.display="none"; guruBox.style.display="block"; loadDashboard(); loadHasil();}
    else{
      studentName=data.nama; studentUser=data.username; studentKelas=data.kelas; studentSekolah=data.idSekolah;
      loginBox.style.display="none"; examBox.style.display="flex"; loadQuestions(); startTimer(30); startCamera(); getLocation();
    }
  });
}

// ===== LOAD SOAL SESUAI KELAS =====
function loadQuestions(){
  fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({mode:"getSoal",username:studentUser})})
  .then(r=>r.json()).then(data=>{
    questions = data.filter(q => q.kelas === studentKelas);
    document.getElementById("kelasSiswa").innerText = studentKelas;
    renderSidebar(); renderQuestion();
  });
}

// ===== SIDEBAR =====
function renderSidebar(){
  let nav=document.getElementById("questionNav");
  nav.innerHTML="";
  questions.forEach((q,i)=>{
    let btn=document.createElement("button");
    btn.innerText=i+1;
    btn.onclick=()=>{currentQuestion=i; renderQuestion();};
    nav.appendChild(btn);
  });
}

// ===== RENDER SOAL =====
function renderQuestion(){
  let q=questions[currentQuestion];
  let html=`<p>${currentQuestion+1}. ${q.soal}</p>`;
  if(q.gambar) html+=`<img src="${q.gambar}" width="200"><br>`;
  if(q.audio) html+=`<audio controls src="${q.audio}"></audio><br>`;
  ['A','B','C','D'].forEach(o=>{
    let val=q[o];
    html+=`<label><input type="radio" name="q${currentQuestion}" value="${val}" ${answers[currentQuestion]===val?'checked':''}> ${val}</label><br>`;
  });
  questions.innerHTML=html;
}

// ===== NAVIGASI =====
function nextQuestion(){saveAnswer(); if(currentQuestion<questions.length-1) currentQuestion++; renderQuestion();}
function prevQuestion(){saveAnswer(); if(currentQuestion>0) currentQuestion--; renderQuestion();}
function saveAnswer(){let sel=document.querySelector(`input[name=q${currentQuestion}]:checked`); answers[currentQuestion]=sel?sel.value:answers[currentQuestion];}

// ===== TIMER =====
function startTimer(mins){let sec=mins*60; timerInterval=setInterval(()=>{
  let m=Math.floor(sec/60), s=sec%60; timer.innerText=(m<10?'0'+m:m)+":"+(s<10?'0'+s:s);
  if(sec<=0){clearInterval(timerInterval); finishExam();}
  sec--;
},1000);}

// ===== CAMERA & ANTI-CHEATING =====
function startCamera(){
  navigator.mediaDevices.getUserMedia({video:true}).then(s=>video.srcObject=s).catch(e=>alert("Tidak bisa akses kamera!"));
  setInterval(()=>{
    if(video.paused || video.ended || video.readyState<2){
      violationCount++; alert("Peringatan: Wajah tidak terlihat!"); capturePhoto();
    }
  },5000);
}
document.addEventListener("visibilitychange",()=>{if(document.hidden){violationCount++; alert("Peringatan: Jangan pindah tab atau buka aplikasi lain!"); capturePhoto();}});
function capturePhoto(){let c=document.createElement("canvas");c.width=video.videoWidth;c.height=video.videoHeight;c.getContext("2d").drawImage(video,0,0);violationPhoto=c.toDataURL();}

// ===== LOCATION =====
function getLocation(){navigator.geolocation.getCurrentPosition(p=>{studentLocation=p.coords.latitude+","+p.coords.longitude;});}

// ===== FINISH EXAM =====
function finishExam(){
  if(!confirm("Apakah yakin menyelesaikan ujian?")) return;
  saveAnswer(); let score=0; questions.forEach((q,i)=>{if(answers[i] && answers[i]===q.jawaban) score++;});
  let persen=(score/questions.length)*100; let cheat="Aman";
  if(violationCount>=1 && violationCount<=2) cheat="Mencurigakan"; if(violationCount>2) cheat="Terindikasi Curang";
  fetch(WEB_APP_URL,{method:"POST",body:JSON.stringify({
    mode:"submit", nama:studentName, username:studentUser, idSekolah:studentSekolah, kelas:studentKelas,
    skor:score,total:questions.length,persen,pelanggaran:violationCount,statusKecurangan:cheat,
    lokasi:studentLocation,foto:violationPhoto,esai:document.getElementById("essayAnswer").value,nilaiEsai:0
  })}).then(r=>alert("Ujian selesai! Nilai: "+persen.toFixed(1)+"% Status: "+cheat));
}

// ===== GURU CRUD & DASHBOARD =====
function tambahSoal(){/* ... Apps Script POST ke mode tambahSoal */}
function editSoal(){/* ... Apps Script POST ke mode editSoal */}
function hapusSoal(){/* ... Apps Script POST ke mode hapusSoal */}
function loadHasil(){/* ... Apps Script POST ke mode getHasil */}
function loadDashboard(){/* ... bisa tampil chart.js */}
</script>
</body>
</html>
