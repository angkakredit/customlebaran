<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CBT Nasional Super</title>

<!-- Library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0;padding:20px}
.card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1);margin-bottom:20px}
button{padding:10px 15px;border:none;border-radius:6px;background:#2b7cff;color:#fff;cursor:pointer}
input,select,textarea{width:100%;padding:8px;margin:5px 0 10px;border-radius:6px;border:1px solid #ccc}
video,audio,img{margin-top:10px;max-width:200px;border-radius:6px}
.question{margin-bottom:15px}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="card" id="loginBox">
<h2>Login CBT Nasional</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button onclick="loginUser()">Login</button>
<button onclick="startQRLogin()">Login via QR</button>
<div id="reader" style="width:250px;margin-top:10px"></div>
</div>

<!-- UJIAN -->
<div class="card" id="examBox" style="display:none">
<h2>Ujian Online</h2>
<div id="questions"></div>
<div class="question">
<b>Jawaban Esai:</b>
<textarea id="essayAnswer" placeholder="Tulis jawaban esai disini..." rows="4"></textarea>
</div>
<video id="video" autoplay muted></video>
<button onclick="finishExam()">Selesai Ujian</button>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxTx6_unkpzvWgFSOywpQlweX9RQ6O9vk4mSPeUPVjpzpEQ-Cq2Aq4P9Ozg33YHh2bq/exec";

let studentName="", studentUser="", violationCount=0;
let violationPhoto="", studentLocation="", questions=[], score=0;

// ===== LOGIN =====
function loginUser(){
  const u = username.value, p = password.value;
  if(!u||!p) return alert("Isi username & password");
  fetch(`${WEB_APP_URL}?mode=login&u=${u}&p=${p}`)
  .then(r=>r.json()).then(data=>{
    if(!data.status){alert("Login gagal"); return;}
    studentName=data.nama; studentUser=data.username;
    startExam();
  });
}

// ===== LOGIN QR =====
function startQRLogin(){
  const qr=new Html5Qrcode("reader");
  qr.start({facingMode:"environment"}, {}, txt=>{
    let [u,p]=txt.split("|");
    username.value=u; password.value=p;
    qr.stop(); loginUser();
  });
}

// ===== MULAI UJIAN =====
function startExam(){
  loginBox.style.display="none"; examBox.style.display="block";
  loadQuestions(); startCamera(); getLocation();
  setInterval(monitorFace,5000); // cek wajah tiap 5 detik
}

// ===== AMBIL SOAL =====
function shuffle(a){return a.sort(()=>Math.random()-0.5);}
function loadQuestions(){
  fetch(`${WEB_APP_URL}?mode=soal`).then(r=>r.json()).then(data=>{
    questions=shuffle(data).slice(0,10); renderQuestions();
  });
}

// ===== RENDER SOAL =====
function renderQuestions(){
  questionsDiv=document.getElementById("questions"); questionsDiv.innerHTML="";
  questions.forEach((q,i)=>{
    const div=document.createElement("div"); div.className="question";

    // Gambar & Audio
    let imgHTML=q[4]?`<img src="${q[4]}">`:"";
    let audioHTML=q[5]?`<audio controls src="${q[5]}"></audio>`:"";

    let opsi=shuffle([q[6],q[7],q[8],q[9]]);
    div.innerHTML=`<p>${i+1}. ${q[3]}</p>${imgHTML}${audioHTML}`+
      opsi.map(o=>`<label><input type='radio' name='q${i}' value='${o}'> ${o}</label><br>`).join("");
    questionsDiv.appendChild(div);
  });
}

// ===== KAMERA =====
function startCamera(){
  navigator.mediaDevices.getUserMedia({video:true})
  .then(s=>video.srcObject=s);
}
function capturePhoto(){
  let c=document.createElement("canvas");
  c.width=video.videoWidth; c.height=video.videoHeight;
  c.getContext("2d").drawImage(video,0,0);
  violationPhoto=c.toDataURL();
}

// ===== DETEKSI WAJAH =====
async function monitorFace(){
  const d=await faceapi.detectAllFaces(video);
  if(d.length!==1){violationCount++; capturePhoto();}
}

// ===== LOKASI =====
function getLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    studentLocation=p.coords.latitude+","+p.coords.longitude;
  });
}

// ===== MONITOR TAB =====
document.addEventListener("visibilitychange",()=>{
  if(document.hidden){violationCount++; capturePhoto();}
});

// ===== HITUNG NILAI =====
function calculateScore(){
  score=0;
  questions.forEach((q,i)=>{
    let ans=document.querySelector(`input[name=q${i}]:checked`);
    if(ans && ans.value==q[10]) score++;
  });
  return score;
}

// ===== SELESAI =====
function finishExam(){
  let total=questions.length;
  let nilai=calculateScore();
  let persen=(nilai/total)*100;

  let cheat="Aman";
  if(violationCount>=1 && violationCount<=2) cheat="Mencurigakan";
  if(violationCount>2) cheat="Terindikasi Curang";

  sendResult(nilai,total,persen,cheat);
  generatePDF(persen,cheat);
  alert(`Nilai: ${persen.toFixed(1)}%\nStatus: ${cheat}`);
}

// ===== KIRIM HASIL KE WEB APP =====
function sendResult(skor,total,persen,cheat){
  fetch(WEB_APP_URL,{
    method:"POST",
    body:JSON.stringify({
      nama:studentName, username:studentUser,
      skor, total, persen,
      pelanggaran:violationCount, statusKecurangan:cheat,
      lokasi:studentLocation, foto:violationPhoto,
      esai:essayAnswer.value
    })
  });
}

// ===== PDF =====
function generatePDF(percent, cheat){
  const {jsPDF}=window.jspdf;
  let doc=new jsPDF();
  doc.text("LAPORAN HASIL UJIAN",20,20);
  doc.text("Nama: "+studentName,20,40);
  doc.text("Nilai: "+percent.toFixed(1)+"%",20,50);
  doc.text("Status: "+cheat,20,60);
  doc.save("hasil_ujian.pdf");
}
</script>

</body>
</html>
